{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ course.title }} | Course Player</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.5/cdn.min.js" defer></script>

  <style>
    .responsive-iframe-container{position:relative;overflow:hidden;padding-top:56.25%;border-radius:1rem}
    .responsive-iframe-container iframe{position:absolute;inset:0;width:100%;height:100%;border:0;border-radius:1rem}
    .glass{backdrop-filter:blur(16px);background:rgba(255,255,255,0.85);border:1px solid rgba(255,255,255,0.4)}
    .glass-dark{backdrop-filter:blur(16px);background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2)}
    .scroll-smooth{scroll-behavior:smooth}
    [x-cloak]{display:none!important}
    
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:rgba(243,244,246,0.5);border-radius:10px}
    ::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#6366f1,#a855f7);border-radius:10px}
    ::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#4f46e5,#9333ea)}
    
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .animate-slide-in{animation:slideIn 0.4s ease-out}
    
    @keyframes pulse-soft{0%,100%{opacity:1}50%{opacity:0.7}}
    .pulse-soft{animation:pulse-soft 2s cubic-bezier(0.4,0,0.6,1) infinite}
    
    .lesson-btn{transition:all 0.2s ease;position:relative;overflow:hidden}
    .lesson-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(99,102,241,0.1),transparent);transition:left 0.5s}
    .lesson-btn:hover::before{left:100%}
    
    .card-hover{transition:all 0.3s ease}
    .card-hover:hover{transform:translateY(-2px);box-shadow:0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04)}
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 text-gray-800 scroll-smooth min-h-screen">

<div class="min-h-screen pb-24 lg:pb-6" x-data="courseApp()" x-init="init()">

  <!-- Enhanced Header -->
  <header class="sticky top-0 z-50 glass shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center gap-4">
        <button class="lg:hidden h-11 w-11 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105" 
                @click="sidebarOpen = true" 
                aria-label="Open menu">
          <svg class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>

        <div class="flex items-center gap-3">
          <div class="h-11 w-11 rounded-xl bg-gradient-to-br from-indigo-600 to-purple-600 shadow-lg grid place-items-center">
            <svg class="h-6 w-6 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V7.89l7-3.11v8.21z"/>
            </svg>
          </div>
          <div class="hidden sm:block">
            <div class="font-bold text-gray-900 text-lg">{{ course.title }}</div>
            <div class="text-xs text-gray-600 line-clamp-1">Interactive Learning Platform</div>
          </div>
        </div>

        <div class="hidden md:flex flex-1 max-w-md ml-auto mr-4">
          <div class="w-full">
            <div class="flex justify-between text-[11px] font-medium text-gray-700 mb-1.5">
              <span>Overall Progress</span>
              <span x-text="progressPct + '%'"></span>
            </div>
            <div class="h-2.5 bg-gray-200/60 rounded-full shadow-inner overflow-hidden">
              <div class="h-full rounded-full bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 transition-all duration-500 ease-out shadow-sm" 
                   :style="`width: ${progressPct}%`"></div>
            </div>
            <div class="flex justify-between text-[10px] text-gray-500 mt-1">
              <span>Completed: <b x-text="completedCount"></b></span>
              <span>Total: <b x-text="totalCount"></b></span>
            </div>
          </div>
        </div>

        <div class="hidden xl:flex items-center gap-2 text-sm text-gray-700 bg-white/60 px-4 py-2 rounded-lg shadow-sm max-w-[400px]">
          <svg class="h-4 w-4 text-indigo-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
          <span class="truncate font-medium" x-text="breadcrumb || 'Select a lesson'"></span>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Drawer -->
  <div class="fixed inset-0 z-50 lg:hidden" x-show="sidebarOpen" x-cloak>
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="sidebarOpen=false"></div>
    <aside class="absolute left-0 top-0 h-full w-11/12 max-w-sm bg-white shadow-2xl overflow-hidden animate-slide-in">
      <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 shadow-lg z-10">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
            </svg>
            <h3 class="text-lg font-bold">Course Content</h3>
          </div>
          <button class="h-9 w-9 rounded-lg bg-white/20 hover:bg-white/30 transition" @click="sidebarOpen=false">
            <svg class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </div>
      
      <div class="p-4 overflow-y-auto h-[calc(100%-5rem)]">
        {% for milestone in course.milestones.all %}
          <div class="mb-3 border-2 border-indigo-200 rounded-2xl overflow-hidden bg-white/60 shadow-md">
            <button class="w-full flex items-center justify-between px-4 py-3 text-left bg-gradient-to-r from-indigo-50 to-purple-50 hover:from-indigo-100 hover:to-purple-100 transition-colors"
                    @click="toggleMilestone('milestone{{ milestone.id }}')">
              <span class="font-bold text-gray-900 flex items-center gap-2">
                <svg class="h-5 w-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/>
                </svg>
                Milestone {{ forloop.counter }}
              </span>
              <svg :class="{'rotate-180': openMilestone==='milestone{{ milestone.id }}'}" 
                   class="h-5 w-5 text-indigo-600 transition-transform" 
                   fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
            <div x-show="openMilestone==='milestone{{ milestone.id }}'" x-collapse class="p-3 space-y-3" style="display:none">
              {% for module in milestone.modules.all %}
                <div class="border-2 border-gray-200 rounded-xl overflow-hidden bg-white/50 ">
                  <button class="w-full flex items-center justify-between px-3 py-2.5 text-left hover:bg-indigo-50/70 transition-colors"
                          @click="toggleModule('module{{ module.id }}')">
                    <span class="text-sm font-bold text-gray-900">Module {{ forloop.counter }}: {{ module.title }}</span>
                    <svg :class="{'rotate-180': openModule==='module{{ module.id }}'}" 
                         class="h-4 w-4 text-indigo-600 transition-transform flex-shrink-0" 
                         fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                  </button>
                  <div x-show="openModule==='module{{ module.id }}'" x-collapse class="px-2 pb-2 space-y-2" style="display:none">
                    {% for content in module.contents.all %}
                      <button class="lesson-btn w-full border-2 rounded-xl px-3 py-3 text-left bg-white hover:bg-indigo-50/80 focus:ring-2 focus:ring-indigo-400 transition-all  group"
                              @click="selectContentById('lesson{{ content.id }}'); sidebarOpen=false"
                              data-id="lesson{{ content.id }}"
                              data-type="{{ content.content_type }}"
                              data-title="Milestone {{ forloop.parentloop.parentloop.counter }} â€º Module {{ forloop.parentloop.counter }} â€º {{ content.title|escapejs }}"
                              data-source="{{ content.source|default_if_none:''|escapejs }}"
                              data-examtime="{{ content.examtime|default_if_none:0 }}"
                              data-desc-id="desc-{{ content.id }}"
                              data-quiz-key="quiz-{{ content.id }}">
                        <div class="flex items-center justify-between gap-2">
                          <div class="flex items-center gap-2.5 flex-1 min-w-0">
                            <span class="inline-flex items-center justify-center h-8 w-8 rounded-lg text-white text-xs font-bold bg-gradient-to-br from-indigo-600 to-purple-600  flex-shrink-0">
                              {{ forloop.counter }}
                            </span>
                            <span class="text-sm text-gray-800 font-medium truncate group-hover:text-indigo-700">
                              {{ content.title }}
                            </span>
                          </div>
                          <span class="text-[10px] px-2 py-1 rounded-full border-2 font-semibold uppercase tracking-wide flex-shrink-0"
                                :class="{
                                  'border-indigo-300 text-indigo-700 bg-indigo-50': '{{ content.content_type }}'==='video',
                                  'border-purple-300 text-purple-700 bg-purple-50': '{{ content.content_type }}'==='quiz',
                                  'border-emerald-300 text-emerald-700 bg-emerald-50': '{{ content.content_type }}'==='resources'
                                }">
                            {{ content.content_type }}
                          </span>
                        </div>
                      </button>

                      <div id="desc-{{ content.id }}" class="hidden">
                        {% if content.description %}
                          {{ content.description|safe }}
                        {% else %}
                          <p class="text-gray-500">No description available for this lesson.</p>
                        {% endif %}
                      </div>

                      {% if content.content_type == 'quiz' %}
                        <div id="quiz-{{ content.id }}" class="hidden">
                          {% for q in content.mcq.all %}
                            <div class="mcq"
                                 data-q="{{ q.question|escape }}"
                                 data-a="{{ q.option_a|escape }}"
                                 data-b="{{ q.option_b|escape }}"
                                 data-c="{{ q.option_c|default_if_none:''|escape }}"
                                 data-d="{{ q.option_d|default_if_none:''|escape }}"
                                 data-correct="{{ q.right_answer|upper }}">
                            </div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </aside>
  </div>

  <!-- Main Layout -->
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- Desktop Sidebar -->
      <aside class="hidden lg:block lg:col-span-4 xl:col-span-3">
        <div class="sticky top-24  rounded-2xl p-5  h-[calc(100vh-8rem)] overflow-y-auto">
          <div class="flex items-center justify-between mb-5 pb-4 border-b border-indigo-200/30">
            <h3 class="text-base font-bold text-gray-900 flex items-center gap-2">
              <svg class="h-5 w-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
              </svg>
              Course Modules
            </h3>
            <div class="text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold ">
              <span x-text="totalCount"></span> Lessons
            </div>
          </div>
          <div class="space-y-3">
            {% for milestone in course.milestones.all %}
              <div class="border-2 border-indigo-200 rounded-2xl overflow-hidden bg-white/60 ">
                <button class="w-full flex items-center justify-between px-4 py-3 text-left bg-gradient-to-r from-indigo-50 to-purple-50 hover:from-indigo-100 hover:to-purple-100 transition-colors"
                        @click="toggleMilestone('milestone{{ milestone.id }}')">
                  <span class="font-bold text-gray-900 flex items-center gap-2">
                    <svg class="h-5 w-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/>
                    </svg>
                    Milestone {{ forloop.counter }}
                  </span>
                  <svg :class="{'rotate-180': openMilestone==='milestone{{ milestone.id }}'}" 
                       class="h-5 w-5 text-indigo-600 transition-transform" 
                       fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                </button>
                <div x-show="openMilestone==='milestone{{ milestone.id }}'" x-collapse class="p-3 space-y-3" style="display:none">
                  {% for module in milestone.modules.all %}
                    <div class="border-2 border-gray-200 rounded-xl overflow-hidden bg-white/50 shadow-sm">
                      <button class="w-full flex items-center justify-between px-3 py-2.5 text-left hover:bg-indigo-50/70 transition-colors"
                              @click="toggleModule('module{{ module.id }}')">
                        <span class="text-sm font-bold text-gray-900">Module {{ forloop.counter }}: {{ module.title }}</span>
                        <svg :class="{'rotate-180': openModule==='module{{ module.id }}'}" 
                             class="h-4 w-4 text-indigo-600 transition-transform flex-shrink-0" 
                             fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                      </button>
                      <div x-show="openModule==='module{{ module.id }}'" x-collapse class="px-2 pb-2 space-y-2" style="display:none">
                        {% for content in module.contents.all %}
                          <button class="lesson-btn w-full border-2 rounded-xl px-3 py-3 text-left bg-white hover:bg-indigo-50/80 focus:ring-2 focus:ring-indigo-400 transition-all shadow-sm hover:shadow-md group"
                                  @click="selectContentById('lesson{{ content.id }}')"
                                  data-id="lesson{{ content.id }}"
                                  data-type="{{ content.content_type }}"
                                  data-title="Milestone {{ forloop.parentloop.parentloop.counter }} â€º Module {{ forloop.parentloop.counter }} â€º {{ content.title|escapejs }}"
                                  data-source="{{ content.source|default_if_none:''|escapejs }}"
                                  data-examtime="{{ content.examtime|default_if_none:0 }}"
                                  data-desc-id="desc-{{ content.id }}"
                                  data-quiz-key="quiz-{{ content.id }}">
                            <div class="flex items-center justify-between gap-2">
                              <div class="flex items-center gap-2.5 flex-1 min-w-0">
                                <span class="inline-flex items-center justify-center h-8 w-8 rounded-lg text-white text-xs font-bold bg-gradient-to-br from-indigo-600 to-purple-600 shadow flex-shrink-0">
                                  {{ forloop.counter }}
                                </span>
                                <span class="text-sm text-gray-800 font-medium truncate group-hover:text-indigo-700">
                                  {{ content.title }}
                                </span>
                              </div>
                              <span class="text-[10px] px-2 py-1 rounded-full border-2 font-semibold uppercase tracking-wide flex-shrink-0"
                                    :class="{
                                      'border-indigo-300 text-indigo-700 bg-indigo-50': '{{ content.content_type }}'==='video',
                                      'border-purple-300 text-purple-700 bg-purple-50': '{{ content.content_type }}'==='quiz',
                                      'border-emerald-300 text-emerald-700 bg-emerald-50': '{{ content.content_type }}'==='resources'
                                    }">
                                {{ content.content_type }}
                              </span>
                            </div>
                          </button>

                          <div id="desc-{{ content.id }}" class="hidden">
                            {% if content.description %}
                              {{ content.description|safe }}
                            {% else %}
                              <p class="text-gray-500">No description available for this lesson.</p>
                            {% endif %}
                          </div>

                          {% if content.content_type == 'quiz' %}
                            <div id="quiz-{{ content.id }}" class="hidden">
                              {% for q in content.mcq.all %}
                                <div class="mcq"
                                     data-q="{{ q.question|escape }}"
                                     data-a="{{ q.option_a|escape }}"
                                     data-b="{{ q.option_b|escape }}"
                                     data-c="{{ q.option_c|default_if_none:''|escape }}"
                                     data-d="{{ q.option_d|default_if_none:''|escape }}"
                                     data-correct="{{ q.right_answer|upper }}">
                                </div>
                              {% endfor %}
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="lg:col-span-8 xl:col-span-9 space-y-5">

        <!-- Navigation Bar -->
        <div class="glass rounded-2xl p-4 shadow-lg">
          <div class="flex flex-col sm:flex-row sm:items-center gap-4">
            <div class="flex items-center gap-3 flex-1">
              <div class="flex items-center gap-2 text-sm">
                <div class="px-3 py-1.5 rounded-lg bg-white shadow-sm border border-indigo-100">
                  <span class="text-gray-600">Lesson </span>
                  <b class="text-indigo-700" x-text="(currentFlatIndex>=0? currentFlatIndex+1 : 0)"></b>
                  <span class="text-gray-400">/</span>
                  <b class="text-gray-700" x-text="flat.length"></b>
                </div>
              </div>
              <div class="hidden sm:block h-8 w-px bg-gray-300"></div>
              <div class="hidden sm:block flex-1 text-sm text-gray-700 truncate font-medium" x-text="breadcrumb || 'No lesson selected'"></div>
            </div>
            
            <div class="flex items-center gap-2">
              <button class="flex items-center gap-2 px-4 py-2.5 rounded-xl border-2 border-gray-300 bg-white hover:bg-gray-50 shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed font-medium" 
                      @click="goPrev()" 
                      :disabled="currentFlatIndex<=0">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                </svg>
                <span class="hidden sm:inline">Previous</span>
              </button>
              <button class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-lg hover:shadow-xl transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed font-semibold" 
                      @click="goNext()" 
                      :disabled="currentFlatIndex>=flat.length-1">
                <span class="hidden sm:inline">Next</span>
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- VIDEO VIEW -->
        <section x-show="view==='video'" x-cloak class="space-y-5 animate-slide-in">
          <div class="glass rounded-2xl overflow-hidden shadow-xl card-hover">
            <div class="responsive-iframe-container bg-black">
              <iframe :src="current.source" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            </div>
          </div>
          
          <div class="glass rounded-2xl p-6 shadow-lg">
            <details class="group" open>
              <summary class="flex items-center justify-between cursor-pointer list-none">
                <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                  <svg class="h-5 w-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                  </svg>
                  Lesson Notes & Resources
                </h3>
                <span class="ml-4 transition-transform duration-200 group-open:rotate-180">
                  <svg class="h-5 w-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                </span>
              </summary>
              <div class="mt-5 prose prose-indigo max-w-none" x-html="current.descriptionHtml"></div>
            </details>
          </div>
        </section>

        <!-- QUIZ VIEW -->
        <section x-show="view==='quiz'" x-cloak class="space-y-5 animate-slide-in">
          <div class="glass rounded-2xl p-6 shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                  <svg class="h-6 w-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                  Assessment Quiz
                </h3>
                <p class="text-sm text-gray-600 mt-1">Complete all questions and submit your answers</p>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 text-sm px-4 py-2 rounded-lg bg-white shadow-sm border">
                  <svg class="h-5 w-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                  </svg>
                  <span class="font-semibold" x-text="examMinutes + ' min'"></span>
                </div>
                <div class="text-2xl font-bold px-4 py-2 rounded-lg shadow-sm" 
                     :class="timeRemaining <= 30 ? 'bg-red-100 text-red-700 pulse-soft' : 'bg-green-100 text-green-700'">
                  <span x-text="formatTime(timeRemaining)"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="glass rounded-2xl overflow-hidden shadow-xl">
            <div class="max-h-[60vh] overflow-y-auto p-6 space-y-5">
              <template x-for="(q, qi) in quiz.questions" :key="qi">
                <div class="bg-white/90 border-2 border-gray-200 rounded-2xl p-5 shadow-md hover:shadow-lg transition-shadow">
                  <div class="flex gap-4">
                    <div class="flex-shrink-0 h-10 w-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-600 text-white font-bold grid place-items-center shadow-lg text-lg" x-text="qi+1"></div>
                    <div class="flex-1">
                      <p class="font-semibold text-gray-900 mb-4 text-lg" x-text="q.q"></p>
                      <div class="space-y-2.5">
                        <template x-for="(opt, oi) in q.options" :key="oi">
                          <label class="cursor-pointer block">
                            <input type="radio" class="peer hidden" :name="`q-${qi}`" :value="['A','B','C','D'][oi]" @change="answers[qi] = ['A','B','C','D'][oi]" :disabled="submitted">
                            <div class="border-2 rounded-xl px-4 py-3.5 bg-white peer-checked:border-purple-500 peer-checked:bg-purple-50 hover:bg-gray-50 transition-all duration-200"
                                 :class="submitted ? ( isCorrect(qi, oi) ? 'border-green-500 bg-green-50 shadow-md' : ( isSelected(qi, oi) ? 'border-red-500 bg-red-50' : 'opacity-50') ) : 'hover:border-purple-300 hover:shadow-sm'">
                              <div class="flex items-center justify-between gap-3">
                                <span class="text-sm flex items-center gap-3">
                                  <b class="text-base font-bold text-gray-700" x-text="['A','B','C','D'][oi]"></b>
                                  <span x-text="opt"></span>
                                </span>
                                <template x-if="submitted && isCorrect(qi, oi)">
                                  <svg class="h-6 w-6 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                  </svg>
                                </template>
                                <template x-if="submitted && !isCorrect(qi, oi) && isSelected(qi, oi)">
                                  <svg class="h-6 w-6 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                  </svg>
                                </template>
                              </div>
                            </div>
                          </label>
                        </template>
                        <template x-if="submitted && !isAnyCorrectSelected(qi)">
                          <div class="text-sm text-gray-600 mt-2 px-3 py-2 bg-green-50 border border-green-200 rounded-lg">
                            âœ“ Correct answer: <b class="text-green-700 font-semibold" x-text="quiz.questions[qi].correct"></b>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            
            <div class="border-t-2 bg-white/80 p-5">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center gap-4 text-sm">
                  <div class="px-4 py-2 rounded-lg bg-gray-100 border shadow-sm">
                    Total: <b class="text-gray-900" x-text="quiz.questions.length"></b>
                  </div>
                  <div class="px-4 py-2 rounded-lg border shadow-sm"
                       :class="answeredCount === quiz.questions.length ? 'bg-green-100 border-green-300 text-green-700' : 'bg-yellow-100 border-yellow-300 text-yellow-700'">
                    Answered: <b x-text="answeredCount"></b>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <button class="px-5 py-2.5 rounded-xl border-2 border-gray-300 bg-white hover:bg-gray-50 shadow-md hover:shadow-lg transition-all font-medium disabled:opacity-40" 
                          @click="confirmReset()" 
                          :disabled="submitted && !canReset">
                    ðŸ”„ Reset
                  </button>
                  <button class="px-6 py-2.5 rounded-xl text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg hover:shadow-xl transition-all font-semibold disabled:opacity-40" 
                          @click="submitQuiz()" 
                          :disabled="submitted">
                    âœ“ Submit Quiz
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div x-show="submitted" x-cloak class="glass rounded-2xl p-6 shadow-lg animate-slide-in">
            <div class="flex flex-col sm:flex-row items-center gap-5">
              <div class="relative">
                <svg class="h-24 w-24 transform -rotate-90">
                  <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="6" fill="none"/>
                  <circle cx="48" cy="48" r="40" stroke="url(#grad)" stroke-width="6" fill="none" stroke-linecap="round"
                          :stroke-dasharray="251.2"
                          :stroke-dashoffset="251.2 - (251.2 * score / quiz.questions.length)"/>
                  <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#6366f1"/>
                      <stop offset="100%" style="stop-color:#a855f7"/>
                    </linearGradient>
                  </defs>
                </svg>
                <div class="absolute inset-0 grid place-items-center">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-gray-900" x-text="score"></div>
                    <div class="text-xs text-gray-500" x-text="'/' + quiz.questions.length"></div>
                  </div>
                </div>
              </div>
              <div class="flex-1">
                <h4 class="text-2xl font-bold text-gray-900 mb-2">Quiz Completed! ðŸŽ‰</h4>
                <p class="text-gray-700">
                  You scored <b class="text-indigo-700" x-text="score"></b> out of <b x-text="quiz.questions.length"></b> questions.
                  <span x-show="score === quiz.questions.length" class="text-green-600 font-semibold">Perfect score!</span>
                </p>
                <p class="text-sm text-gray-500 mt-2" x-show="autoSubmitted">âš¡ Auto-submitted when time expired.</p>
              </div>
            </div>
          </div>

          <div class="glass rounded-2xl p-6 shadow-lg">
            <h4 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
              <svg class="h-5 w-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
              Lesson Description
            </h4>
            <div class="prose prose-indigo max-w-none" x-html="current.descriptionHtml"></div>
          </div>
        </section>

        <!-- RESOURCES VIEW -->
        <section x-show="view==='resources'" x-cloak class="animate-slide-in">
          <div class="glass rounded-2xl p-6 shadow-lg">
            <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="h-6 w-6 text-emerald-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
              </svg>
              Course Resources
            </h3>
            <div class="prose prose-emerald max-w-none" x-html="current.descriptionHtml"></div>
          </div>
        </section>

        <!-- EMPTY STATE -->
        <section x-show="!view" x-cloak>
          <div class="glass rounded-2xl p-16 text-center shadow-lg">
            <div class="inline-flex items-center justify-center h-20 w-20 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 text-white mb-5 shadow-lg">
              <svg class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
              </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Welcome to {{ course.title }}</h3>
            <p class="text-gray-600 max-w-md mx-auto mb-6">Select a lesson from the sidebar to begin your learning journey. Track your progress as you complete each module.</p>
            <button class="lg:hidden px-6 py-3 rounded-xl text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-lg font-semibold" @click="sidebarOpen=true">
              Browse Lessons
            </button>
          </div>
        </section>

        <!-- NOTES SECTION -->
        {% comment %} <section class="glass rounded-2xl p-6 shadow-lg">
          <div class="flex items-center gap-2 mb-4">
            <svg class="h-6 w-6 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
              <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
            </svg>
            <h3 class="text-lg font-bold text-gray-900">Personal Notes</h3>
          </div>
          <textarea class="w-full border-2 border-gray-200 rounded-xl p-4 bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none min-h-[140px] transition-all resize-none" 
                    placeholder="âœï¸ Take notes while learning... Your thoughts and key takeaways go here." 
                    x-model="notes"></textarea>
          <div class="mt-3 flex items-center justify-between">
            <div class="text-xs text-gray-500">
              <span x-text="notes.length"></span> characters
            </div>
            <button class="px-5 py-2 rounded-lg text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 shadow-md hover:shadow-lg transition-all font-medium">
              ðŸ’¾ Save Notes
            </button>
          </div>
        </section> {% endcomment %}

      </main>
    </div>
  </div>

  <!-- Mobile Bottom Navigation -->
  <div class="lg:hidden fixed bottom-0 inset-x-0 z-40 p-3 bg-gradient-to-t from-white via-white to-transparent pointer-events-none">
    <div class="glass rounded-2xl p-3 shadow-2xl pointer-events-auto">
      <div class="flex items-center justify-between gap-3">
        <button class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl border-2 border-gray-300 bg-white hover:bg-gray-50 shadow-md transition-all disabled:opacity-40 font-medium" 
                @click="goPrev()" 
                :disabled="currentFlatIndex<=0">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
          </svg>
          <span>Prev</span>
        </button>
        
        <div class="px-4 py-3 rounded-xl bg-white shadow-sm border-2 border-gray-200 font-bold text-gray-700 text-sm whitespace-nowrap">
          <span x-text="(currentFlatIndex>=0? currentFlatIndex+1 : 0)"></span>/<span x-text="flat.length"></span>
        </div>
        
        <button class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-white bg-gradient-to-r from-indigo-600 to-purple-600 shadow-lg transition-all disabled:opacity-40 font-semibold" 
                @click="goNext()" 
                :disabled="currentFlatIndex>=flat.length-1">
          <span>Next</span>
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
      
      <div class="mt-3 px-2">
        <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
          <div class="h-full bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 rounded-full transition-all duration-500" 
               :style="`width: ${progressPct}%`"></div>
        </div>
        <div class="flex justify-between text-[10px] text-gray-600 mt-1.5 font-medium">
          <span>Progress: <b x-text="progressPct + '%'"></b></span>
          <span><b x-text="completedCount"></b> of <b x-text="totalCount"></b></span>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
function courseApp(){
  return {
    sidebarOpen: false,
    openMilestone: null,
    openModule: null,
    flat: [],
    currentFlatIndex: -1,
    totalCount: 0,
    completedCount: 0,
    view: '',
    current: { id:null, type:null, title:'', source:'', descriptionHtml:'' },
    breadcrumb: '',
    notes: '',
    quiz: { questions: [] },
    answers: {},
    submitted: false,
    autoSubmitted: false,
    canReset: true,
    score: 0,
    examMinutes: 0,
    timeRemaining: 0,
    _timerHandle: null,

    init(){
      const btns = Array.from(document.querySelectorAll('.lesson-btn'));
      const seen = new Set();
      this.flat = btns.map(el => ({
        id: el.dataset.id,
        type: el.dataset.type,
        title: el.dataset.title,
        source: el.dataset.source,
        examtime: Number(el.dataset.examtime || 0),
        descId: el.dataset.descId,
        quizKey: el.dataset.quizKey
      })).filter(item => {
        if(seen.has(item.id)) return false;
        seen.add(item.id);
        return true;
      });
      this.totalCount = this.flat.length;
    },

    toggleMilestone(id){ this.openMilestone = (this.openMilestone===id ? null : id); },
    toggleModule(id){ this.openModule = (this.openModule===id ? null : id); },

    selectContentById(id){
      const item = this.flat.find(x => x.id === id);
      if(!item) return;
      this.currentFlatIndex = this.flat.findIndex(x => x.id === id);
      this._renderContent(item);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    goNext(){
      if(this.currentFlatIndex < this.flat.length - 1){
        const idx = ++this.currentFlatIndex;
        this._renderContent(this.flat[idx]);
        this.completedCount = Math.max(this.completedCount, idx+1);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    },

    goPrev(){
      if(this.currentFlatIndex > 0){
        const idx = --this.currentFlatIndex;
        this._renderContent(this.flat[idx]);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    },

    _renderContent(payload){
      this._clearTimer();
      this.current = {
        id: payload.id,
        type: payload.type,
        title: payload.title,
        source: payload.source,
        descriptionHtml: (document.getElementById(payload.descId)?.innerHTML ?? '<p class="text-gray-500">No description available.</p>')
      };
      this.breadcrumb = payload.title;
      this.view = payload.type;

      if(this.view === 'quiz'){
        const nodes = document.querySelectorAll(`#${payload.quizKey} .mcq`);
        const qs = Array.from(nodes).map(n => ({
          q: n.dataset.q || '',
          options: [n.dataset.a, n.dataset.b, n.dataset.c, n.dataset.d].filter(Boolean),
          correct: (n.dataset.correct || 'A').toUpperCase()
        })).filter(q => q.q && q.options.length);
        this.quiz = { questions: qs };
        this.answers = {};
        this.submitted = false;
        this.autoSubmitted = false;
        this.score = 0;
        this.examMinutes = Number(payload.examtime || 0);
        
        if(this.examMinutes > 0){
          this.timeRemaining = this.examMinutes * 60;
          this._timerHandle = setInterval(() => {
            this.timeRemaining--;
            if(this.timeRemaining <= 0){
              this._clearTimer();
              if(!this.submitted){ 
                this.autoSubmitted = true; 
                this.submitQuiz(); 
              }
            }
          }, 1000);
        } else { 
          this.timeRemaining = 0; 
        }
      }
    },

    isSelected(qi, oi){ return this.answers[qi] === ['A','B','C','D'][oi]; },
    isCorrect(qi, oi){ return (this.quiz.questions[qi]?.correct) === ['A','B','C','D'][oi]; },
    isAnyCorrectSelected(qi){ return this.answers[qi] === this.quiz.questions[qi]?.correct; },
    get answeredCount(){ return Object.keys(this.answers).length; },

    submitQuiz(){
      if(this.submitted) return;
      this.submitted = true;
      let s = 0;
      this.quiz.questions.forEach((q, qi) => { 
        if(this.answers[qi] === q.correct) s++; 
      });
      this.score = s;
      this._clearTimer();
    },

    confirmReset(){
      if(!confirm('Are you sure you want to reset all your answers? This action cannot be undone.')) return;
      this.answers = {}; 
      this.submitted = false; 
      this.autoSubmitted = false; 
      this.score = 0;
      
      if(this.view==='quiz' && this.examMinutes>0){
        this._clearTimer();
        this.timeRemaining = this.examMinutes * 60;
        this._timerHandle = setInterval(() => {
          this.timeRemaining--;
          if(this.timeRemaining <= 0){ 
            this._clearTimer(); 
            if(!this.submitted){ 
              this.autoSubmitted = true; 
              this.submitQuiz(); 
            } 
          }
        }, 1000);
      }
    },

    _clearTimer(){ 
      if(this._timerHandle){ 
        clearInterval(this._timerHandle); 
        this._timerHandle = null; 
      } 
    },

    get progressPct(){ 
      const t = this.totalCount || 1; 
      const pct = Math.round((this.completedCount / t) * 100); 
      return isNaN(pct) ? 0 : pct; 
    },

    formatTime(sec){ 
      sec = Math.max(0, sec||0); 
      const m = String(Math.floor(sec/60)).padStart(2,'0'); 
      const s = String(sec%60).padStart(2,'0'); 
      return `${m}:${s}`; 
    },
  }
}
</script>

</body>
</html>