{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ course.title }} | Course Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.5/cdn.min.js" defer></script>
  <style>
    .responsive-iframe-container {
      position: relative;
      overflow: hidden;
      padding-top: 56.25%;
      border-radius: 0.5rem;
    }
    .responsive-iframe-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 0.5rem;
    }
    [x-cloak] { display: none !important; }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
  </style>
</head>
<body class="bg-gray-50" x-data="courseApp()" x-init="init()">

  <!-- Header -->
  <header class=" ">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button class=" p-0 rounded-lg " >
            <a href="{% url 'enroll_course' %}"><svg width="20px" height="20px" viewBox="0 0 75.80 75.80" xmlns="http://www.w3.org/2000/svg" fill="#170707" stroke="#170707" transform="rotate(0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Group_64" data-name="Group 64" transform="translate(-624.082 -383.588)"> <path id="Path_56" data-name="Path 56" d="M660.313,383.588a1.5,1.5,0,0,1,1.06,2.561l-33.556,33.56a2.528,2.528,0,0,0,0,3.564l33.556,33.558a1.5,1.5,0,0,1-2.121,2.121L625.7,425.394a5.527,5.527,0,0,1,0-7.807l33.556-33.559A1.5,1.5,0,0,1,660.313,383.588Z" fill="#000000"></path> </g> </g></svg>
          </a></button>
          <div>
            <h1 class="text-lg lg:text-xl font-bold text-gray-900">{{ course.title }}</h1>
            
          </div>
        </div>
        
        <div class="hidden md:flex items-center gap-4">
          <div class="text-sm text-gray-600">
            Progress: <span class="font-semibold" x-text="progressPct + '%'"></span>
          </div>
          <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
            <div class="h-full bg-green-600 transition-all" :style="`width: ${progressPct}%`"></div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Sidebar -->
  

  <!-- Quiz Data Storage (Outside loops - only once per quiz) -->
  <div id="quiz-data-storage" style="display:none;">
    {% for milestone in course.milestones.all %}
      {% for module in milestone.modules.all %}
        {% for content in module.contents.all %}
          {% if content.content_type == 'quiz' %}
            <div id="quiz-data-{{ content.id }}" 
                 data-quiz='[{% for q in content.mcq.all %}{"q":"{{ q.question|escapejs }}","a":"{{ q.option_a|escapejs }}","b":"{{ q.option_b|escapejs }}","c":"{{ q.option_c|default_if_none:''|escapejs }}","d":"{{ q.option_d|default_if_none:''|escapejs }}","correct":"{{ q.right_answer|upper }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'>
            </div>
          {% endif %}
        {% endfor %}
      {% endfor %}
    {% endfor %}
  </div>

  <!-- Main Layout -->
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6  ">
      
      <!-- Desktop Sidebar -->
      <aside class=" lg:col-span-4 order-2 lg:order-1">
        <div class="bg-white rounded-lg border p-4 sticky top-24 max-h-[calc(100vh-1rem)] overflow-y-auto">
          <h3 class="font-bold mb-4 pb-3 border-b text-base lg:text-xl">Course Content</h3>
          <div class="space-y-3">
            {% for milestone in course.milestones.all %}
              <div class="border rounded-lg overflow-hidden">
                <button class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 transition"
                        @click="toggleMilestone('milestone{{ milestone.id }}')">
                  <span class="font-bold text-lg text-gray-900">Milestone {{ forloop.counter }}</span>
                  <svg :class="{'rotate-180': openMilestone==='milestone{{ milestone.id }}'}" 
                       class="w-5 h-5 transition-transform" 
                       fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                </button>
                
                <div x-show="openMilestone==='milestone{{ milestone.id }}'" x-collapse class="border-t" style="display:none">
                  {% for module in milestone.modules.all %}
                    <div class="border-b last:border-b-0">
                      <button class="w-full flex items-center justify-between p-3 hover:bg-gray-50 transition"
                              @click="toggleModule('module{{ module.id }}')">
                        <span class="text-base font-semibold text-gray-900">Module {{ forloop.counter }}: {{ module.title }}</span>
                        <svg :class="{'rotate-180': openModule==='module{{ module.id }}'}" 
                             class="w-4 h-4 transition-transform" 
                             fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                      </button>
                      
                      <div x-show="openModule==='module{{ module.id }}'" x-collapse class="bg-gray-50 p-2 space-y-2" style="display:none">
                        {% for content in module.contents.all %}
                          <button class="lesson-btn w-full text-left p-3 rounded-lg border bg-white hover:bg-green-50 hover:border-green-300 transition"
                                  @click="selectContentById('lesson{{ content.id }}')"
                                  data-id="lesson{{ content.id }}"
                                  data-type="{{ content.content_type }}"
                                  data-title="Milestone {{ forloop.parentloop.parentloop.counter }} â€º Module {{ forloop.parentloop.counter }} â€º {{ content.title|escapejs }}"
                                  data-source="{{ content.source|default_if_none:''|escapejs }}"
                                  data-examtime="{{ content.examtime|default_if_none:0 }}"
                                  data-desc-id="desc-{{ content.id }}"
                                  data-quiz-key="quiz-{{ content.id }}">
                            <div class="flex items-center gap-3">
                              <span class="flex-shrink-0 w-8 h-8 rounded-full bg-green-600 text-white text-sm font-bold flex items-center justify-center">
                                {{ forloop.counter }}
                              </span>
                              <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 truncate text-base">{{ content.title }}</div>
                                <span class="inline-block mt-1 px-2 py-0.5 text-xs rounded-full"
                                      :class="{
                                        'bg-green-100 text-green-700': '{{ content.content_type }}'==='video',
                                        'bg-purple-100 text-purple-700': '{{ content.content_type }}'==='quiz',
                                        'bg-green-100 text-green-700': '{{ content.content_type }}'==='resources'
                                      }">
                                  {{ content.content_type }}
                                </span>
                              </div>
                            </div>
                          </button>

                          <div id="desc-{{ content.id }}" class="hidden">
                            {% if content.description %}
                              {{ content.description|safe }}
                            {% else %}
                              <p class="text-gray-500">No description available for this lesson.</p>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="lg:col-span-8 space-y-4 pb-2 lg:pb-4 order-1 lg:order-2">
        
        <!-- Navigation -->
        

        <!-- Video View -->
        <section x-show="view === 'video'" x-cloak>
          <div class="bg-white rounded-lg border overflow-hidden">
            <div class="responsive-iframe-container bg-black">
              <iframe :src="current.source" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
          </div>
          <div x-data="{ showDescription: false }" class="bg-white rounded-lg border p-3 mt-4">
  <!-- Button to toggle description -->
  <button @click="showDescription = !showDescription" class="w-full justify-between items-center text-green-600 font-semibold flex items-center gap-2">
    <!-- Title -->
    <h3 class="text-lg font-bold">Description</h3>

    <!-- Arrow icon that changes based on the showDescription state -->
    <svg :class="{'rotate-180': showDescription}" class="w-5 h-5 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
    </svg>
  </button>

  <!-- Description Section -->
  <div x-show="showDescription" class="prose max-w-none" x-html="current.descriptionHtml">
    <!-- Your dynamic content will go here -->
  </div>
</div>

        </section>

        <!-- Quiz View -->
        <section x-show="view === 'quiz'" x-cloak>
          <div class="bg-white rounded-lg border p-4 mb-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold">Quiz</h3>
              <div class="flex items-center gap-3">
                <span class="text-sm text-gray-600" x-show="examMinutes > 0" x-text="examMinutes + ' minutes'"></span>
                <span class="text-xl font-bold" 
                      x-show="examMinutes > 0"
                      :class="timeRemaining <= 30 ? 'text-red-600' : 'text-gray-900'"
                      x-text="formatTime(timeRemaining)"></span>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg border overflow-hidden">
            <div class="lg:p-6 space-y-6 max-h-[300px] overflow-y-auto">
              <template x-for="(q, qi) in quiz.questions" :key="qi">
                <div class="">
                  <div class="flex gap-3">
                    <span class="flex-shrink-0 w-8 h-8 rounded-full bg-green-600 text-white font-bold flex items-center justify-center" x-text="qi + 1"></span>
                    <div class="flex-1">
                      <p class="font-medium mb-3" x-text="q.q"></p>
                      <div class="space-y-2">
                        <template x-for="(opt, oi) in q.options" :key="oi">
                          <label class="block cursor-pointer">
                            <input type="radio" class="peer hidden" :name="`q-${qi}`" :value="['A','B','C','D'][oi]" @change="answers[qi] = ['A','B','C','D'][oi]" :disabled="submitted">
                            <div class="border rounded-lg p-3 peer-checked:border-green-500 peer-checked:bg-green-50 hover:bg-gray-50 transition"
                                 :class="submitted ? (isCorrect(qi, oi) ? 'border-green-500 bg-green-50' : (isSelected(qi, oi) ? 'border-red-500 bg-red-50' : 'opacity-50')) : ''">
                              <div class="flex items-center justify-between">
                                <span class="flex items-center gap-2">
                                  <span class="font-bold" x-text="['A','B','C','D'][oi]"></span>
                                  <span x-text="opt"></span>
                                </span>
                                <template x-if="submitted && isCorrect(qi, oi)">
                                  <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                  </svg>
                                </template>
                              </div>
                            </div>
                          </label>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            
            <div class="border-t p-4">
              <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                  Answered: <span class="font-semibold" x-text="answeredCount + ' / ' + quiz.questions.length"></span>
                </div>
                <div class="flex gap-2">
                  <button @click="confirmReset()" :disabled="submitted && !canReset"
                          class="px-4 py-2 rounded-lg border hover:bg-gray-50 disabled:opacity-50 transition">
                    Reset
                  </button>
                  <button @click="submitQuiz()" :disabled="submitted"
                          class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 transition">
                    Submit
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div x-show="submitted" x-cloak class="bg-white rounded-lg border p-6 mt-4">
            <div class="flex items-center gap-4">
              <div class="text-4xl">ðŸŽ‰</div>
              <div>
                <h4 class="text-lg font-bold">Quiz Completed!</h4>
                <p class="text-gray-600">
                  You scored <span class="font-bold text-green-600" x-text="score"></span> out of <span x-text="quiz.questions.length"></span>
                </p>
                <p class="text-sm text-gray-500 mt-1" x-show="autoSubmitted">âš¡ Auto-submitted when time expired.</p>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-lg border p-6 mt-4">
            <h3 class="text-lg font-bold mb-3">Lesson Description</h3>
            <div class="prose max-w-none" x-html="current.descriptionHtml"></div>
          </div>
        </section>

        <!-- Resources View -->
        <section x-show="view === 'resources'" x-cloak>
          <div class="bg-white rounded-lg border p-6">
            <h3 class="text-lg font-bold mb-3">Course Resources</h3>
            <div class="prose max-w-none" x-html="current.descriptionHtml"></div>
          </div>
        </section>
        <div class="bg-white rounded-lg border p-4">
          <div class="flex items-center justify-between gap-4">
            <div class="text-sm text-gray-600">
              Lesson <span class="font-semibold" x-text="(currentFlatIndex >= 0 ? currentFlatIndex + 1 : 0)"></span> of <span x-text="flat.length"></span>
            </div>
            <div class="flex gap-2">
              <button @click="goPrev()" :disabled="currentFlatIndex <= 0"
                      class="px-4 py-2 rounded-lg border hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Previous
              </button>
              <button @click="goNext()" :disabled="currentFlatIndex >= flat.length - 1"
                      class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Next
              </button>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <section x-show="!view" x-cloak>
          <div class="bg-white rounded-lg border p-12 text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
              <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold mb-2">Welcome to {{ course.title }}</h3>
            <p class="text-gray-600 mb-4">Select a lesson from the sidebar to start learning</p>
            
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Mobile Bottom Nav -->
  <div class="lg:hidden fixed bottom-0 inset-x-0 bg-white border-t p-4 shadow-lg z-40">
    <div class="flex items-center justify-between gap-4 mb-3">
      <button @click="goPrev()" :disabled="currentFlatIndex <= 0"
              class="flex-1 px-4 py-2 rounded-lg border hover:bg-gray-50 disabled:opacity-50 transition">
        Previous
      </button>
      <div class="px-4 py-2 border rounded-lg font-bold text-sm">
        <span x-text="(currentFlatIndex >= 0 ? currentFlatIndex + 1 : 0)"></span>/<span x-text="flat.length"></span>
      </div>
      <button @click="goNext()" :disabled="currentFlatIndex >= flat.length - 1"
              class="flex-1 px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 transition">
        Next
      </button>
    </div>
    <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
      <div class="h-full bg-green-600 transition-all" :style="`width: ${progressPct}%`"></div>
    </div>
    <div class="flex justify-between text-base text-gray-600 mt-1.5">
      <span>Progress: <b x-text="progressPct + '%'"></b></span>
      <span><b x-text="completedCount"></b> of <b x-text="totalCount"></b></span>
    </div>
  </div>

  <script>
    function courseApp() {
      return {
        sidebarOpen: false,
        openMilestone: null,
        openModule: null,
        flat: [],
        currentFlatIndex: -1,
        totalCount: 0,
        completedCount: 0,
        view: '',
        current: { id: null, type: null, title: '', source: '', descriptionHtml: '' },
        breadcrumb: '',
        quiz: { questions: [] },
        answers: {},
        submitted: false,
        autoSubmitted: false,
        canReset: true,
        score: 0,
        examMinutes: 0,
        timeRemaining: 0,
        _timerHandle: null,

        init() {
          const btns = Array.from(document.querySelectorAll('.lesson-btn'));
          const seen = new Set();
          this.flat = btns.map(el => ({
            id: el.dataset.id,
            type: el.dataset.type,
            title: el.dataset.title,
            source: el.dataset.source,
            examtime: Number(el.dataset.examtime || 0),
            descId: el.dataset.descId,
            quizKey: el.dataset.quizKey
          })).filter(item => {
            if(seen.has(item.id)) return false;
            seen.add(item.id);
            return true;
          });
          this.totalCount = this.flat.length;
        },

        toggleMilestone(id) { 
          this.openMilestone = (this.openMilestone === id ? null : id); 
        },
        
        toggleModule(id) { 
          this.openModule = (this.openModule === id ? null : id); 
        },

        selectContentById(id) {
          const item = this.flat.find(x => x.id === id);
          if (!item) return;
          this.currentFlatIndex = this.flat.findIndex(x => x.id === id);
          this._renderContent(item);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        goNext() {
          if (this.currentFlatIndex < this.flat.length - 1) {
            const idx = ++this.currentFlatIndex;
            this._renderContent(this.flat[idx]);
            this.completedCount = Math.max(this.completedCount, idx + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        },

        goPrev() {
          if (this.currentFlatIndex > 0) {
            const idx = --this.currentFlatIndex;
            this._renderContent(this.flat[idx]);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        },

        _renderContent(payload) {
          this._clearTimer();
          this.current = {
            id: payload.id,
            type: payload.type,
            title: payload.title,
            source: payload.source,
            descriptionHtml: (document.getElementById(payload.descId)?.innerHTML ?? '<p class="text-gray-500">No description available.</p>')
          };
          this.breadcrumb = payload.title;
          this.view = payload.type;

          if (this.view === 'quiz') {
            // Get quiz data from centralized storage (only generated once)
            const quizId = payload.quizKey.replace('quiz-', ''); // Extract content ID
            const quizContainer = document.getElementById('quiz-data-' + quizId);
            
            if (!quizContainer || !quizContainer.dataset.quiz) {
              console.error('Quiz data not found for:', quizId);
              this.quiz = { questions: [] };
              return;
            }
            
            try {
              const quizData = JSON.parse(quizContainer.dataset.quiz);
              const qs = quizData.map(item => {
                const q = (item.q || '').trim();
                
                // Build options array without duplicates
               // Build options array without duplicates
// Build options array without duplicates
// Ensure unique options for each question
// Collect options for the question
const options = [];
const seenOptions = new Set();

// Loop through the possible option keys (a, b, c, d)
['a', 'b', 'c', 'd'].forEach(key => {
  const opt = (item[key] || '').trim();
  if (opt && !seenOptions.has(opt.toLowerCase())) {
    options.push(opt);
    seenOptions.add(opt.toLowerCase());  // Ensure no duplicate options
  }
});

// If we have fewer than 4 unique options, we should report an error or handle it
if (options.length < 4) {
  
  console.error('Not enough unique options! We only found ' + options.length + ' unique options.');
} else {
  // Proceed with displaying the unique options
  // You can now safely render the options
}

                
                const correct = (item.correct || 'A').toUpperCase();
                
                return { q, options, correct };
              }).filter(q => q.q && q.options.length > 0);
              
              this.quiz = { questions: qs };
            } catch (e) {
              console.error('Error parsing quiz data:', e);
              this.quiz = { questions: [] };
            }
            
            this.answers = {};
            this.submitted = false;
            this.autoSubmitted = false;
            this.score = 0;
            this.examMinutes = Number(payload.examtime || 0);
            
            if (this.examMinutes > 0) {
              this.timeRemaining = this.examMinutes * 60;
              this._timerHandle = setInterval(() => {
                this.timeRemaining--;
                if (this.timeRemaining <= 0) {
                  this._clearTimer();
                  if (!this.submitted) {
                    this.autoSubmitted = true;
                    this.submitQuiz();
                  }
                }
              }, 1000);
            } else {
              this.timeRemaining = 0;
            }
          }
        },

        isSelected(qi, oi) { return this.answers[qi] === ['A','B','C','D'][oi]; },
        isCorrect(qi, oi) { return (this.quiz.questions[qi]?.correct) === ['A','B','C','D'][oi]; },
        get answeredCount() { return Object.keys(this.answers).length; },

        submitQuiz() {
          if (this.submitted) return;
          this.submitted = true;
          let s = 0;
          this.quiz.questions.forEach((q, qi) => {
            if (this.answers[qi] === q.correct) s++;
          });
          this.score = s;
          this._clearTimer();
        },

        confirmReset() {
          if (!confirm('Are you sure you want to reset all your answers?')) return;
          this.answers = {};
          this.submitted = false;
          this.autoSubmitted = false;
          this.score = 0;
          
          if (this.view === 'quiz' && this.examMinutes > 0) {
            this._clearTimer();
            this.timeRemaining = this.examMinutes * 60;
            this._timerHandle = setInterval(() => {
              this.timeRemaining--;
              if (this.timeRemaining <= 0) {
                this._clearTimer();
                if (!this.submitted) {
                  this.autoSubmitted = true;
                  this.submitQuiz();
                }
              }
            }, 1000);
          }
        },

        _clearTimer() {
          if (this._timerHandle) {
            clearInterval(this._timerHandle);
            this._timerHandle = null;
          }
        },

        get progressPct() {
          const t = this.totalCount || 1;
          const pct = Math.round((this.completedCount / t) * 100);
          return isNaN(pct) ? 0 : pct;
        },

        formatTime(sec) {
          sec = Math.max(0, sec || 0);
          const m = String(Math.floor(sec / 60)).padStart(2, '0');
          const s = String(sec % 60).padStart(2, '0');
          return `${m}:${s}`;
        }
      }
    }
  </script>

</body>
</html>